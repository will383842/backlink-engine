# ============================================================
# PostgreSQL 16 - Optimized for Hetzner CPX22
# ============================================================
# RAM allocated to PostgreSQL: 1GB (via Docker limits)
# CPX22 specs: 2 vCPU, 4 GB RAM total
# ============================================================

# ──────────────────────────────────────────────────────────
# MEMORY SETTINGS
# ──────────────────────────────────────────────────────────

# shared_buffers: Mémoire partagée pour cache de données
# Recommandation: 25% de RAM allouée
shared_buffers = 256MB

# effective_cache_size: Estimation RAM disponible pour cache OS
# Recommandation: 75% de RAM allouée
effective_cache_size = 768MB

# work_mem: Mémoire par opération de tri/hash
# Recommandation: RAM/(max_connections * 4)
# 1GB / (50 * 4) = 5MB → on met 4MB pour être safe
work_mem = 4MB

# maintenance_work_mem: Mémoire pour VACUUM, CREATE INDEX
# Recommandation: 64MB pour petites DB
maintenance_work_mem = 64MB

# ──────────────────────────────────────────────────────────
# WRITE-AHEAD LOG (WAL)
# ──────────────────────────────────────────────────────────

# wal_buffers: Buffers pour écriture WAL
# Recommandation: 16MB pour SSD
wal_buffers = 16MB

# checkpoint_completion_target: Étalement des checkpoints
# 0.9 = étalement sur 90% de l'intervalle (réduit pics I/O)
checkpoint_completion_target = 0.9

# max_wal_size: Taille max WAL avant checkpoint forcé
# 1GB = bon équilibre recovery/performance
max_wal_size = 1GB

# min_wal_size: Taille min WAL conservée
min_wal_size = 256MB

# wal_compression: Compression WAL (économise I/O)
wal_compression = on

# ──────────────────────────────────────────────────────────
# QUERY PLANNER (Optimisé pour SSD)
# ──────────────────────────────────────────────────────────

# random_page_cost: Coût accès aléatoire (4.0 pour HDD, 1.1 pour SSD)
random_page_cost = 1.1

# effective_io_concurrency: Nombre d'opérations I/O parallèles
# SSD NVMe Hetzner supporte ~200 IOPS
effective_io_concurrency = 200

# ──────────────────────────────────────────────────────────
# CONNECTIONS
# ──────────────────────────────────────────────────────────

# max_connections: Nombre max connexions simultanées
# Backlink-engine: ~10-20 connexions suffisent
max_connections = 50

# ──────────────────────────────────────────────────────────
# LOGGING (Production)
# ──────────────────────────────────────────────────────────

# log_min_duration_statement: Log queries > 1 seconde
log_min_duration_statement = 1000

# log_line_prefix: Format des logs
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# log_checkpoints: Log des checkpoints (utile pour tuning)
log_checkpoints = on

# log_connections: Log connexions (désactivé en prod pour perfs)
log_connections = off

# log_disconnections: Log déconnexions (désactivé en prod)
log_disconnections = off

# log_lock_waits: Log des attentes de locks (deadlock detection)
log_lock_waits = on

# ──────────────────────────────────────────────────────────
# AUTOVACUUM (Maintenance automatique)
# ──────────────────────────────────────────────────────────

# autovacuum: Activation du VACUUM automatique
autovacuum = on

# autovacuum_max_workers: Nombre de workers VACUUM
autovacuum_max_workers = 2

# autovacuum_naptime: Intervalle entre VACUUMs (1 min)
autovacuum_naptime = 60s

# ──────────────────────────────────────────────────────────
# STATISTICS
# ──────────────────────────────────────────────────────────

# track_activities: Tracker les requêtes en cours
track_activities = on

# track_counts: Tracker stats tables/indexes
track_counts = on

# track_io_timing: Tracker temps I/O (léger overhead)
track_io_timing = on

# ──────────────────────────────────────────────────────────
# LOCALE
# ──────────────────────────────────────────────────────────

# Locale: C (meilleure performance pour index texte)
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# ──────────────────────────────────────────────────────────
# TIMEZONE
# ──────────────────────────────────────────────────────────

timezone = 'UTC'

# ============================================================
# PERFORMANCE ATTENDUE (CPX22)
# ============================================================
# - Queries simples: < 10ms
# - Queries complexes (joins): < 100ms
# - VACUUM: automatique, non bloquant
# - Checkpoint: toutes les 5-10 minutes (smooth)
# - Connexions max: 50 (largement suffisant)
# ============================================================
